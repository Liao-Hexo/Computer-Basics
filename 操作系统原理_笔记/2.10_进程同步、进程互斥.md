## 进程同步

进程具有异步性的特征，异步性是指，各并发执行的进程以各自独立的、不可预知的速度向前推进

但是有时候我们需要进程确定性的顺序向前推进，操作系统提供“进程同步机制”来实现需求

![](https://tva1.sinaimg.cn/large/008i3skNly1gr5z7aho40j30wg06waet.jpg)

同步亦称直接制约关系，它是指为完成某种任务而建立的两个或多个进程，这些进程因为需要在某些位置上协调它们的工作次序而产生的制约关系。进程间的直接制约关系就是源于它们之间的相互合作

## 进程互斥

进程的“并发”需要“共享”的支持，各个并发执行的进程不可避免的需要共享一些系统资源（内存、打印机、摄像头）

两种资源共享方式：

- 互斥共享方式：系统中的某些资源，虽然可以提供给多个进程使用，但一个时间段内只允许一个进程访问该资源
- 同时共享方式：系统中的某些资源，允许一个时间段内由多个进程“同时”对它们进行访问

我们把一个时间段内只允许一个进程使用的资源称为临界资源，许多物理设备（摄像头、打印机）都属于临界资源，此外还有许多变量、数据、内存缓冲区等都属于临界资源。对临界资源的访问，必须互斥的进行

互斥，亦称间接制约关系，进程互斥指当一个进程访问某临界资源时，另一个想要访问该临界资源的进程必须等待。当前访问临界资源的进程访问结束，释放该资源后，另一个进程才能去访问临界资源

![](https://tva1.sinaimg.cn/large/008i3skNly1gr5zq7dd5yj30sg0e8124.jpg)

如果一个进程暂时不能进入临界区，那么该进程是否应该一直占着处理机？该进程有没有可能一直进不了临界区？

为了实现对临界资源的互斥访问，同时保证系统整体性能，需要遵循以下原则：

1. 空闲让进：临界区空闲时，可以允许一个请求进入临界区的进程立即进入临界区
2. 忙着等待：当已有进程进入临界区时，其他试图进入临界区的进程必须等待
3. 有限等待：对请求访问的进程，应保证能在有限时间内进入临界区（保证不会饥饿）
4. 让权等待：当进程不能进入临界区时，应立即释放处理机，防止进程忙等待

## 进程互斥的软件实现方法

如果没有注意进程互斥：

![](https://tva1.sinaimg.cn/large/008i3skNly1gr60a9hhndj60tm0d442g02.jpg)

### 单标志法

⭐️在进入区只做检查，不上锁

算法思想：两个进程在访问完临界区后会把使用临界区的权限转交给另一个进程。也就是说每个进程进入临界区的权限只能被另一个进程赋予

![](https://tva1.sinaimg.cn/large/008i3skNly1gr60jl4dp6j30vu0c648z.jpg)

因此，该算法可以实现“同一时刻最多只允许一个进程访问临界区”

只能轮流访问，这种必须轮流访问带来的问题是，如果此时允许进入临界区的进程是P0，而P0一直不访问临界区，那么虽然此时临界区空闲，但是并不允许P1访问，因此单标志法存在的主要问题是：违背了“空闲让进”原则

### 双标志先检查

⭐️在进入区先检查后上锁

![](https://tva1.sinaimg.cn/large/008i3skNly1gr60v4u2adj30x60bkam5.jpg)

若按照1、5、2、6、3、7的顺序执行，P0和P1将会同时访问临界区，因此双标志先检查法的主要问题是：违反“忙则等待”原则

原因在于，进入区的“检查”和“上锁”两个处理不是一气呵成的，检查后，上锁前可能发生进程切换

❗️双标志先检查法其实是很好的，唯一的缺点就在于检查和上锁不是一气呵成的，如果能通过硬件方式改进这点就好了！

### 双标志后检查

⭐️在进入区先上锁后检查

![](https://tva1.sinaimg.cn/large/008i3skNly1gr615adxgjj30wc0f8h0k.jpg)

### Peterson算法

⭐️在进入区“主动争取--主动谦让--检查对方是否想进、己方是否谦让”

![](https://tva1.sinaimg.cn/large/008i3skNly1gr618esu6bj30wc0g4dqv.jpg)

![](https://tva1.sinaimg.cn/large/008i3skNly1gr61drlt8rj30mk0c2k0p.jpg)

Peterson算法用软件方法解决了进程互斥的问题，遵循了空闲让进、忙则等待、有限等待三个原则，但是依然未遵循让权等待的原则，会发生“忙等”

Peterson算法相较于之前三种软件解决方案来说是最好的，但依然不够好

## 进程互斥的硬件实现方法

### 中断屏蔽方法

利用“开/关中断指令”实现（与原语的实现思想相同，即在某进程开始访问临界区到结束访问为止都不允许被中断，也就不能发生进程切换，因此也不可能发生两个同时访问临界区的情况）

![](https://tva1.sinaimg.cn/large/008i3skNly1gr62ka1ylpj30fm06oadw.jpg)

优点：简单、高效

缺点：不适用于多处理机；只适用于操作系统内核进程，不适用于用户进程（因为开/关中断指令只能运行在内核态，这组指令如果能让用户随意使用会很危险）

### TestAndSet（TS指令/TSL指令）

![](https://tva1.sinaimg.cn/large/008i3skNly1gr62sv2eibj30x80dc13r.jpg)

优点：实现简单，无需像软件实现方法那样严格检查是否会有逻辑漏洞；适用于多处理机环境

缺点：不满足“让权等待”原则，暂时无法进入临界区的进程会占用CPU并循环执行TSL指令，从而导致“忙等”

### Swap指令（XCHG指令）

![](https://tva1.sinaimg.cn/large/008i3skNly1gr6322gj0uj30um0f0k2i.jpg)

❗️目前，所有的解决方案都无法实现“让权等待”